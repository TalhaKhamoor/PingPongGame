<!DOCTYPE html>
<html>
  <head>
    <title>Ping Pong Game</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <canvas id="canvas" width="800" height="400"></canvas>
    <script type="text/javascript" src="js/app.js"></script>
    <script type="text/javascript">
      //variables
      let speedOfPaddle1 = 0;
      let speedOfPaddle2 = 0;
      let xVector = 0;
      let yVector = 0;
      let isGamePaused = false;
      let isGameStarted = false;
      let savedxVector = 0;
      let savedyVector = 0;
      let playerOneScore = 0;
      let playerTwoScore = 0;
      let playerOne;
      let playerTwo;
      let ball;

      app.onInit = function () {
        this.canvas = document.getElementById("canvas");

        this.nodes.push({
          id: "player-one",
          x: canvas.width / 80,
          y: canvas.height / 2 - (canvas.height * 0.2) / 2,
          width: canvas.width * 0.01,
          height: canvas.height * 0.2,
          color: "white",
        });
        this.nodes.push({
          id: "player-two",
          x: canvas.width - (canvas.width / 80 + canvas.width * 0.01),
          y: canvas.height / 2 - (canvas.height * 0.2) / 2,
          width: canvas.width * 0.01,
          height: canvas.height * 0.2,
          color: "white",
        });
        this.nodes.push({
          id: "ball",
          x: canvas.width / 2,
          y: canvas.height / 2,
          width: this.getNode("player-one").width,
          height: this.getNode("player-one").width,
          color: "white",
          direction: 0,
        });
        this.nodes.push({
          id: "line",
          x: canvas.width / 2 - 3.5,
          y: 0,
          width: 7,
          height: canvas.height,
          color: "white",
        });
        this.nodes.push({
          id: "text",
          value: "Talha Khamoor's PingPong",
          sizeAndFont: "25px Arial",
          x: 30,
          y: 50,
        });
        this.nodes.push({
          id: "text",
          value:
            " - [Space] to start/Pause/Unpause game , - [r] to restart , - [w] [s] player 1 keys , - [up arrow] [down arrow] player 2 keys",
          sizeAndFont: "15px Arial",
          x: 50,
          y: 80,
        });

        document.addEventListener("keydown", (e) => {
          switch (true) {
            case e.keyCode == 32:
              app.pause();
              break;
            case e.keyCode == 82:
              app.reset();
              break;
            case e.keyCode == 87 && !isGamePaused:
              speedOfPaddle1 = -2;
              break;
            case e.keyCode == 83 && !isGamePaused:
              speedOfPaddle1 = +2;
              break;
            case e.keyCode == 38 && !isGamePaused:
              speedOfPaddle2 = -2;
              break;
            case e.keyCode == 40 && !isGamePaused:
              speedOfPaddle2 = +2;
              break;
          }
        });

        document.addEventListener("keyup", (e) => {
          switch (e.keyCode) {
            case 87:
              speedOfPaddle1 = 0;
              break;
            case 83:
              speedOfPaddle1 = 0;
              break;
            case 38:
              speedOfPaddle2 = 0;
              break;
            case 40:
              speedOfPaddle2 = 0;
              break;
          }
        });

        isGameStarted = true;
      };

      app.onUpdate = function (time) {
        [playerOne, playerTwo, ball] = getEntities();

        reflectBallPaddle(playerOne, playerTwo, ball);

        movePaddles(playerOne, playerTwo);

        moveBall(ball);

        lockInPadles(playerOne, playerTwo);

        lockInBall(ball);

        score(ball);
      };

      app.pause = function () {
        if (xVector == 0) {
          xVector = xVector + savedxVector;
          yVector = yVector + savedyVector;
          isGamePaused = false;
        } else {
          savedxVector = xVector;
          savedyVector = yVector;
          xVector = 0;
          yVector = 0;
          if (isGameStarted) {
            this.nodes.push({
              id: "text",
              value:
                playerOneScore.toString() + " : " + playerTwoScore.toString(),
              sizeAndFont: "50px Arial",
              x: 600,
              y: 300,
            });
          }
          isGamePaused = true;
        }
        if (!isGamePaused) {
          this.nodes.splice(4, this.nodes.length);
        }
      };

      app.reset = function () {
        let [playerOne, playerTwo, ball] = getEntities();

        ball.x = canvas.width / 2;
        ball.y = canvas.height / 2;

        playerOne.y = playerTwo.y =
          canvas.height / 2 - (canvas.height * 0.2) / 2;

        xVector = randomiseKickOff(xVector);
        yVector = randomiseKickOff(yVector);

        app.pause();
      };

      function reflectBallPaddle(playerOne, playerTwo, ball) {
        let player = ball.x < canvas.width / 2 ? playerOne : playerTwo;

        if (isBallTouchingPaddle(player)) xVector = -xVector;
      }

      function movePaddles(playerOne, playerTwo) {
        playerOne.y += speedOfPaddle1;
        playerTwo.y += speedOfPaddle2;
      }

      function moveBall(ball) {
        ball.x += xVector;
        ball.y += yVector;
      }

      function lockInPadles(playerOne, playerTwo) {
        if (playerOne.y <= 0) {
          playerOne.y = 0;
        }
        if (playerTwo.y <= 0) {
          playerTwo.y = 0;
        }
        if (playerOne.y >= canvas.height - playerOne.height) {
          playerOne.y = canvas.height - playerOne.height;
        }
        if (playerTwo.y >= canvas.height - playerTwo.height) {
          playerTwo.y = canvas.height - playerTwo.height;
        }
      }

      function lockInBall(ball) {
        if (ball.y <= 12 / 2 || ball.y >= canvas.height - ball.width / 2) {
          yVector = -yVector;
        }
      }

      function score(ball) {
        if (!isGameStarted) return app.reset();
        if (ball.x <= 12 / 2) {
          playerTwoScore++;
          console.log("PlayerTwo : " + playerTwoScore);
          app.reset();
        } else if (ball.x >= canvas.width - ball.width / 2) {
          playerOneScore++;
          console.log("PlayerOne : " + playerOneScore);
          app.reset();
        }
      }

      function randomiseKickOff(coordinates) {
        if (Math.random() < 0.5) {
          return (coordinates = -2);
        } else {
          return (coordinates = +2);
        }
      }

      function isBallTouchingPaddle(player) {
        [playerOne, playerTwo, ball] = getEntities();
        var isBallHittingYCoordinates =
          player.y <= ball.y && ball.y <= player.y + player.height
            ? true
            : false;

        if (
          player.x == ball.x + ball.width / 2 &&
          player == playerTwo &&
          isBallHittingYCoordinates
        ) {
          return true;
        } else if (
          player.x + player.width == ball.x - ball.width / 2 &&
          player == playerOne &&
          isBallHittingYCoordinates
        )
          return true;
        else {
          return false;
        }
      }

      function getEntities() {
        playerOne = app.getNode("player-one");
        playerTwo = app.getNode("player-two");
        ball = app.getNode("ball");

        return (entities = [playerOne, playerTwo, ball]);
      }
    </script>
  </body>
</html>
