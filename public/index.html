<!DOCTYPE html>
<html>
  <head>
    <title>Ping Pong Game</title>
    <style>
      body,
      html {
        width: 100%;
        height: 100%;
        margin: 0;
        overflow: hidden;
        display: block;
        background-color: black;
      }
    </style>
  </head>
  <body>
    <canvas
      id="canvas"
      width="800"
      height="400"
      style="
        background-color: black;
        border: 12px dashed white;
        padding-left: 0;
        padding-right: 0;
        margin-left: auto;
        margin-right: auto;
        display: block;
        width: 98%;
      "
    ></canvas>
    <script type="text/javascript" src="js/app.js"></script>
    <script type="text/javascript">
      //variables
      var speedOfPaddle1 = null;
      var speedOfPaddle2 = null;
      var xCoordDirection = null;
      var yCoordDirection = null;
      var isGamePaused = true;
      var isGameStarted = false;
      var savedXCoordDirection = 2;
      var savedYCoordDirection = 2;
      var playerOneScore = 0;
      var playerTwoScore = -1;

      // sets up our game and some evenlisteners when server is started
      app.onInit = function () {
        // getting Canvas from app and its context
        this.canvas = document.getElementById("canvas");
        this.context = this.canvas.getContext("2d");
        // adding player one to our nodes array
        this.nodes.push({
          id: "player-one",
          x: canvas.width / 80,
          y: canvas.height / 2 - (canvas.height * 0.2) / 2,
          width: canvas.width * 0.01,
          height: canvas.height * 0.2,
          color: "white",
        });
        // adding player two to our nodes array
        this.nodes.push({
          id: "player-two",
          x: canvas.width - (canvas.width / 80 + canvas.width * 0.01),
          y: canvas.height / 2 - (canvas.height * 0.2) / 2,
          width: canvas.width * 0.01,
          height: canvas.height * 0.2,
          color: "white",
        });
        // adding ball to our nodes array
        this.nodes.push({
          id: "ball",
          x: canvas.width / 2,
          y: canvas.height / 2,
          width: this.getNode("player-one").width,
          height: this.getNode("player-one").width,
          color: "white",
          direction: 0,
        });
        /**
         *  The rest of the nodes onwards would have been better off in a different array
         *  but I wanted to keep the changes in app.js to a minimum as it was instructed too.
         **/
        // adding line to our array
        this.nodes.push({
          id: "line",
          x: canvas.width / 2 - 3.5,
          y: 0,
          width: 7,
          height: canvas.height,
          color: "white",
        });
        // adding text to our array
        this.nodes.push({
          id: "text",
          value: "Talha Khamoor's PingPong",
          sizeAndFont: "25px Arial",
          x: 30,
          y: 50,
        });
        // adding text to our array
        this.nodes.push({
          id: "text",
          value:
            " - [Space] to start/Pause/Unpause game , - [r] to restart , - [w] [s] player 1 keys , - [up arrow] [down arrow] player 2 keys",
          sizeAndFont: "15px Arial",
          x: 50,
          y: 80,
        });

        // even listner for checking if a key is pressed down
        document.addEventListener("keydown", (e) => {
          // if statements to figure out which key is pressed
          // pause/unpause game
          if (e.keyCode == 32) {
            app.pause();
            // splices off all the text nodes from our array
            this.nodes.splice(4, this.nodes.length);
          }
          // reset game
          if (e.keyCode == 82) {
            app.reset();
          }
          // control of player one and two paddles
          if (!isGamePaused) {
            if (e.keyCode == 87) {
              speedOfPaddle1 = -2;
            } else if (e.keyCode == 83) {
              speedOfPaddle1 = +2;
            } else if (e.keyCode == 38) {
              speedOfPaddle2 = -2;
            } else if (e.keyCode == 40) {
              speedOfPaddle2 = +2;
            }
          }
        });

        // event listener to see if any keys were released
        document.addEventListener("keyup", (e) => {
          // control of stopping player one and two paddles
          if (e.keyCode == 87) {
            speedOfPaddle1 = 0;
          } else if (e.keyCode == 83) {
            speedOfPaddle1 = 0;
          } else if (e.keyCode == 38) {
            speedOfPaddle2 = 0;
          } else if (e.keyCode == 40) {
            speedOfPaddle2 = 0;
          }
        });
      };

      // runs everytime there is an update, so most of our logical functions are here
      app.onUpdate = function (time) {
        var playerOne = this.getNode("player-one");
        var playerTwo = this.getNode("player-two");
        var ball = this.getNode("ball");

        // when paddlespeed on evenlistener increase's, this moves paddle
        movePaddles(playerOne, playerTwo);
        // when coordinates of ball on event listener change, this moves the ball
        moveBall(ball);
        // preventing paddle from going off canvas
        lockInPadles(playerOne, playerTwo);

        // preventing ball from leaving top and bottom, inversing the y direction
        LockInBall(ball);

        // figuring out which player has ball on their side
        let player = ball.x < canvas.width / 2 ? playerOne : playerTwo;

        // ball hitting sidewall, increasing score
        scored(ball);

        // preventing ball from going pass paddle, inversing x direction
        if (isBallTouchingPaddle(player, ball, playerOne, playerTwo))
          xCoordDirection = -xCoordDirection;
      };

      // moves ball
      function moveBall(ball) {
        ball.x += xCoordDirection;
        ball.y += yCoordDirection;
      }

      // moves paddle based of incresed speeds
      function movePaddles(playerOne, playerTwo) {
        playerOne.y += speedOfPaddle1;
        playerTwo.y += speedOfPaddle2;
      }

      // locks in paddle within canvas
      function lockInPadles(playerOne, playerTwo) {
        if (playerOne.y <= 0) {
          playerOne.y = 0;
        }
        if (playerTwo.y <= 0) {
          playerTwo.y = 0;
        }
        if (playerOne.y >= canvas.height - playerOne.height) {
          playerOne.y = canvas.height - playerOne.height;
        }
        if (playerTwo.y >= canvas.height - playerTwo.height) {
          playerTwo.y = canvas.height - playerTwo.height;
        }
      }

      // locks in ball within canvas
      function LockInBall(ball) {
        if (ball.y <= 12 / 2 || ball.y >= canvas.height - ball.width / 2) {
          yCoordDirection = -yCoordDirection;
        }
      }

      // increases score and initiates reset
      function scored(ball) {
        if (ball.x <= 12 / 2) {
          playerTwoScore++;
          console.log("PlayerTwo : " + playerTwoScore);
          app.reset();
        } else if (ball.x >= canvas.width - ball.width / 2) {
          playerOneScore++;
          console.log("PlayerOne : " + playerOneScore);
          app.reset();
        }
      }

      // checks if ball is touching paddle
      isBallTouchingPaddle = (player, ball, playerOne, playerTwo) => {
        // turing operator to see if ball is within paddle y bounds
        var isBallHittingYCoordinates =
          player.y <= ball.y && ball.y <= player.y + player.height
            ? true
            : false;
        // if else tree to make ball bounce of the right edge of paddle
        if (
          player.x == ball.x + ball.width / 2 &&
          player == playerTwo &&
          isBallHittingYCoordinates
        ) {
          return true;
        } else if (
          player.x + player.width == ball.x - ball.width / 2 &&
          player == playerOne &&
          isBallHittingYCoordinates
        )
          return true;
        else {
          return false;
        }
        // player.x == ball.x + ball.width / 2 ||
        //           player.x + player.width == ball.x - ball.width / 2)
      };

      // pauses game
      app.pause = function () {
        // if ball is stopped game is paused
        if (xCoordDirection == 0) {
          xCoordDirection = xCoordDirection + savedXCoordDirection;
          yCoordDirection = yCoordDirection + savedYCoordDirection;
          isGamePaused = false;
        } else {
          savedXCoordDirection = xCoordDirection;
          savedYCoordDirection = yCoordDirection;
          xCoordDirection = 0;
          yCoordDirection = 0;
          if (!isGamePaused) {
            this.nodes.push({
              id: "text",
              value:
                playerOneScore.toString() + " : " + playerTwoScore.toString(),
              sizeAndFont: "50px Arial",
              x: 600,
              y: 300,
            });
          }
          isGamePaused = true;
        }
      };

      // resets game
      app.reset = function () {
        var playerOne = app.getNode("player-one");
        var playerTwo = app.getNode("player-two");
        var ball = app.getNode("ball");
        // resetting ball
        ball.x = canvas.width / 2;
        ball.y = canvas.height / 2;
        // restting paddles
        playerOne.y = playerTwo.y =
          canvas.height / 2 - (canvas.height * 0.2) / 2;
        //restting ball direction
        xCoordDirection = randomiseKickOff(xCoordDirection);
        yCoordDirection = randomiseKickOff(yCoordDirection);
        // pauses game to be started with space again
        app.pause();
      };

      // refactored - randomize which direction the ball will take off
      function randomiseKickOff(coordinates) {
        if (Math.random() < 0.5) {
          return (coordinates = -2);
        } else {
          return (coordinates = +2);
        }
      }
    </script>
  </body>
</html>
